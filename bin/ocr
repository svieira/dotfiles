#!/usr/bin/env swift
// Via https://codeberg.org/EvanHahn/dotfiles/
import Foundation
import Vision

func die(_ msg: String) -> Never {
  fputs("\(msg)\n", stderr)
  exit(1)
}

let args = CommandLine.arguments
var useStdIn = false
if args.count > 2 {
  die("usage: ocr /path/to/image.jpg")
} else if args.count == 2 {
  useStdIn = args[1] == "-"
} else if isatty(FileHandle.standardInput.fileDescriptor) {
  useStdIn = true
} else {
  die("usage: ocr /path/to/image.png")
}

let path = URL(fileURLWithPath: args[1])

var recognizeTextRequest = RecognizeTextRequest()
recognizeTextRequest.automaticallyDetectsLanguage = true
recognizeTextRequest.usesLanguageCorrection = true
recognizeTextRequest.recognitionLevel = .accurate

guard let observations = try? await recognizeTextRequest.perform(on: path) else {
  die("couldn't recognize text")
}

for observation in observations {
  if let candidate = observation.topCandidates(1).first {
    print(candidate.string)
  }
}